# Specification: 统一输入多 Webview 页面

**Created**: 2025-01-27  
**Feature**: 统一输入多 Webview 页面  
**Status**: Draft

## Constitution Check

本规范遵循项目宪法原则：
- ✅ Minimal Dependencies: 依赖最小化，不引入额外的输入管理库
- ✅ Modern Standards: 使用 React 18、TypeScript、现代 CSS
- ✅ Code Quality: 组件化设计，单一职责，代码简洁清晰
- ✅ Performance First: 优化多 webview 同时加载的性能

## Scope

### 功能范围

本功能扩展现有的 AI 工具集成页面，添加以下能力：

1. **统一输入框**: 在页面顶部提供一个统一的 AI 对话输入框
2. **多 Webview 同时显示**: 同时显示多个 AI 工具的 webview 页面（如 ChatGPT、DeepSeek 等）
3. **输入分发**: 用户在统一输入框中输入内容后，自动将输入内容传递到所有显示的 webview 页面中

### 不在本功能范围内

- 输入框的历史记录功能
- 输入内容的编辑和撤销功能
- Webview 之间的消息同步（仅单向：输入框 → webview）
- 输入内容的格式化或预处理
- 多语言输入支持（假设使用中文输入）

## User Scenarios & Testing

### 场景 1: 用户首次使用统一输入功能

**前置条件**: 
- 应用已启动
- 至少配置了两个 AI 工具（如 ChatGPT 和 DeepSeek）

**用户操作**:
1. 用户打开应用
2. 看到页面顶部有一个统一的输入框
3. 看到下方同时显示多个 webview（每个 AI 工具一个）
4. 用户在输入框中输入问题："什么是 React？"
5. 用户点击发送按钮或按 Enter 键

**预期结果**:
- 输入内容同时传递到所有显示的 webview 页面
- 每个 webview 页面都接收到相同的输入内容
- 用户可以看到每个 AI 工具都在处理这个问题

**验收标准**:
- ✅ 统一输入框清晰可见且易于使用
- ✅ 所有配置的 AI 工具 webview 同时显示
- ✅ 输入内容成功传递到所有 webview
- ✅ 传递过程在 1 秒内完成

### 场景 2: 用户切换显示的工具

**前置条件**: 
- 应用已启动
- 用户已使用过统一输入功能

**用户操作**:
1. 用户通过工具切换控件选择要显示的 AI 工具
2. 用户选择显示 ChatGPT 和 DeepSeek（取消其他工具）
3. 用户在统一输入框中输入新问题
4. 用户发送输入

**预期结果**:
- 只有当前选中的工具 webview 显示
- 输入内容只传递到当前显示的 webview
- 隐藏的 webview 不接收输入内容

**验收标准**:
- ✅ 工具切换功能正常工作
- ✅ 输入只传递到显示的 webview
- ✅ 切换响应时间 < 500ms

### 场景 3: 输入传递失败处理

**前置条件**: 
- 应用已启动
- 多个 webview 正在显示

**用户操作**:
1. 用户在统一输入框中输入内容
2. 用户发送输入
3. 其中一个 webview 无法接收输入（网络错误或页面未加载完成）

**预期结果**:
- 成功传递的 webview 正常显示输入内容
- 失败的 webview 显示错误提示
- 用户可以看到哪些工具成功接收了输入，哪些失败
- 提供重试选项

**验收标准**:
- ✅ 部分失败不影响其他 webview
- ✅ 错误提示清晰明确
- ✅ 提供重试机制

### 场景 4: 输入框为空时发送

**前置条件**: 
- 应用已启动

**用户操作**:
1. 用户在统一输入框中不输入任何内容
2. 用户点击发送按钮或按 Enter 键

**预期结果**:
- 不执行任何操作
- 显示提示信息："请输入内容"
- 不向任何 webview 传递内容

**验收标准**:
- ✅ 空输入被正确拦截
- ✅ 提示信息用户友好

## Requirements

### 功能需求

#### FR1: 统一输入框
- **FR1.1**: 系统应在页面顶部提供一个统一的输入框组件
- **FR1.2**: 输入框应支持文本输入（至少 1000 字符）
- **FR1.3**: 输入框应提供发送按钮
- **FR1.4**: 输入框应支持 Enter 键发送（Shift+Enter 换行）
- **FR1.5**: 输入框应显示字符计数或最大长度提示（如需要）
- **FR1.6**: 输入框应支持基本的文本编辑功能（复制、粘贴、撤销）

#### FR2: 多 Webview 布局
- **FR2.1**: 系统应支持同时显示多个 webview（至少 2 个，最多 4 个）
- **FR2.2**: Webview 应以网格布局显示（如 2x2、1x2、2x1 等）
- **FR2.3**: 用户应能够通过工具切换控件选择要显示的 webview
- **FR2.4**: 每个 webview 应显示对应的 AI 工具名称或标识
- **FR2.5**: Webview 布局应响应式适配不同屏幕尺寸

#### FR3: 输入内容传递
- **FR3.1**: 用户发送输入后，系统应将输入内容传递到所有当前显示的 webview
- **FR3.2**: 输入传递应在 1 秒内完成
- **FR3.3**: 系统应支持通过 JavaScript 注入或 DOM 操作将输入传递到 webview
- **FR3.4**: 如果某个 webview 未加载完成，系统应等待其加载完成后再传递（最多等待 5 秒）
- **FR3.5**: 传递失败时应显示错误提示

#### FR4: 输入传递机制
- **FR4.1**: 系统应能够识别每个 webview 中的输入框元素
- **FR4.2**: 系统应将统一输入框的内容填充到每个 webview 的输入框中
- **FR4.3**: 系统应能够触发每个 webview 的发送操作（点击发送按钮或触发提交事件）
- **FR4.4**: 如果 webview 页面结构不同，系统应支持多种输入框识别策略

#### FR5: 状态反馈
- **FR5.1**: 系统应显示每个 webview 的输入传递状态（成功/失败/进行中）
- **FR5.2**: 系统应在输入传递过程中显示加载指示器
- **FR5.3**: 系统应记录输入历史（当前会话内，不持久化）

### 非功能需求

#### NFR1: 性能
- **NFR1.1**: 页面加载时间 < 3 秒（包含多个 webview）
- **NFR1.2**: 输入传递响应时间 < 1 秒
- **NFR1.3**: 同时显示 4 个 webview 时，内存使用 < 500MB
- **NFR1.4**: 切换显示的工具时，响应时间 < 500ms

#### NFR2: 可用性
- **NFR2.1**: 输入框应支持常见的键盘快捷键（Ctrl+A、Ctrl+C、Ctrl+V 等）
- **NFR2.2**: 界面应清晰直观，用户无需学习即可使用
- **NFR2.3**: 错误提示应用户友好，避免技术术语

#### NFR3: 兼容性
- **NFR3.1**: 支持 Windows 10/11、macOS、Linux
- **NFR3.2**: 支持不同的 AI 工具页面结构（ChatGPT、DeepSeek 等）
- **NFR3.3**: 如果某个 AI 工具页面结构变化导致无法传递输入，应优雅降级（显示错误提示）

## Technical Constraints

### 技术限制

1. **Webview 跨域限制**: 由于安全限制，可能无法直接访问 webview 内的 DOM。需要使用 Electron 的 IPC 通信或 JavaScript 注入。

2. **页面结构差异**: 不同的 AI 工具页面可能有不同的 DOM 结构，需要支持多种输入框识别策略。

3. **性能限制**: 同时加载多个 webview 可能影响性能，需要优化加载策略。

4. **输入框识别**: 需要能够可靠地识别每个 webview 中的输入框元素，可能需要使用选择器或内容检测。

### 假设

1. **页面结构稳定性**: 假设主要 AI 工具（ChatGPT、DeepSeek）的页面结构相对稳定，输入框选择器不会频繁变化。

2. **JavaScript 注入**: 假设可以通过 Electron webview 的 JavaScript 注入功能来操作页面 DOM。

3. **用户意图**: 假设用户希望同时向多个 AI 工具发送相同的问题，以获得不同的回答。

## Success Criteria

### 定量指标

1. **功能完整性**: 
   - 100% 的功能需求（FR1-FR5）已实现并通过测试
   - 所有用户场景（场景 1-4）可以成功执行

2. **性能指标**:
   - 页面加载时间 < 3 秒（包含 4 个 webview）
   - 输入传递响应时间 < 1 秒（传递到 4 个 webview）
   - 工具切换响应时间 < 500ms

3. **可靠性**:
   - 输入传递成功率 > 95%（在正常网络条件下）
   - 错误处理覆盖率 100%（所有错误场景都有处理）

### 定性指标

1. **用户体验**:
   - 用户可以在 30 秒内理解如何使用统一输入功能
   - 界面直观，无需阅读文档即可使用
   - 错误提示清晰，用户知道如何解决问题

2. **代码质量**:
   - 代码符合项目宪法原则
   - 组件化设计，易于维护和扩展
   - 代码通过 lint 检查，无类型错误

## Dependencies

### 内部依赖

- **001-ai-integration**: 依赖现有的 AI 工具集成功能，包括工具配置、webview 组件等

### 外部依赖

- **Electron webview API**: 需要 Electron 的 webview 标签和 JavaScript 注入功能
- **AI 工具页面结构**: 依赖目标 AI 工具页面的 DOM 结构（ChatGPT、DeepSeek 等）

## Assumptions

1. **输入框识别**: 假设可以通过 CSS 选择器或内容特征识别每个 AI 工具页面的输入框
2. **页面加载**: 假设 webview 页面可以在合理时间内加载完成（< 10 秒）
3. **用户需求**: 假设用户希望同时向多个 AI 工具发送相同问题
4. **工具数量**: 假设用户最多同时使用 4 个 AI 工具
5. **输入长度**: 假设单个输入不超过 1000 字符

## Edge Cases

1. **Webview 未加载完成**: 用户发送输入时，某个 webview 仍在加载中
2. **页面结构变化**: AI 工具页面更新导致输入框选择器失效
3. **网络错误**: 某个 webview 无法加载或网络中断
4. **输入框不存在**: 某个 webview 页面中没有找到输入框元素
5. **多个输入框**: 某个 webview 页面中有多个可能的输入框
6. **输入框被禁用**: 输入框存在但被禁用（如需要登录）
7. **特殊字符**: 输入内容包含特殊字符或换行符
8. **快速连续输入**: 用户在短时间内连续发送多条输入

## Open Questions

已通过研究文档 (research.md) 解决：

1. **输入传递方式**: 使用 JavaScript 注入直接操作 DOM（填充输入框并触发发送）
   - 实现简单，性能好，符合最小化原则
   - 详见 research.md Decision 1

2. **Webview 布局**: 使用网格布局（2x2、1x2、2x1 等），支持响应式调整
   - 可以同时对比多个 AI 工具的回答
   - 详见 research.md Decision 2

3. **工具选择**: 使用复选框列表，用户勾选要显示的工具
   - 简单直观，快速操作
   - 详见 research.md Decision 3
