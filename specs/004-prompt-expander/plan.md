# Prompt迭代拓展生成工具技术规划

## Constitution Check

本计划遵循项目宪法原则：

- ✅ **Minimal Dependencies**: 
  - ✅ 使用Node.js原生http/https模块调用AI API，零额外依赖
  - ✅ 使用React Context进行状态管理，零额外依赖（Zustand仅1KB，可选）
  - ✅ 使用Electron内置文件系统API，零依赖
  - ✅ 使用Electron dialog API进行文件导出，零依赖
  - ✅ **总体积**: 0-1KB (gzipped)，完全符合最小依赖原则
- ✅ **Modern Standards**: 
  - ✅ 使用React Hooks和函数组件（React 18.2.0）
  - ✅ 使用TypeScript确保类型安全（TypeScript 5.9.3）
  - ✅ 使用现代CSS特性（CSS Modules）
  - ✅ 使用ES6+语法和现代异步模式（async/await）
  - ✅ 使用Electron IPC进行进程间通信
- ✅ **Code Quality**: 
  - ✅ 组件职责单一，结构清晰（6个专用组件）
  - ✅ 完整的TypeScript类型定义（data-model.md）
  - ✅ 遵循一致的命名和文件组织规范
  - ✅ 完善的错误处理和用户反馈机制
  - ✅ 清晰的接口定义（contracts/）
- ✅ **Performance First**: 
  - ✅ AI调用使用异步处理，不阻塞UI（IPC + 主进程）
  - ✅ 使用React.memo优化渲染性能
  - ✅ 实现合理的加载状态和错误重试（最多3次）
  - ✅ 历史记录数据合理管理，避免内存泄漏（文件系统存储）
  - ✅ 实现请求超时机制（30秒）

## Overview

本规划旨在为Prompt迭代拓展生成工具提供技术实现方案。该工具允许用户从初始需求开始，通过AI辅助的迭代拓展过程（5-10次迭代），逐步完善并最终生成详细的提示词。

**项目类型**: Electron + React 桌面应用新功能模块
**技术栈**: React 18.2.0 + TypeScript 5.9.3 + Vite 7.3.1
**目标平台**: Electron 39.2.7 (Chromium)
**功能模块**: 新增独立工具页面，集成到现有应用架构

## Technical Context

### 现有技术栈
- **语言/版本**: TypeScript 5.9.3
- **框架**: React 18.2.0
- **构建工具**: Vite 7.3.1
- **运行时**: Electron 39.2.7
- **样式方案**: CSS Modules
- **主要依赖**: React, React DOM, lucide-react
- **应用架构**: 侧边栏导航 + 工具页面切换

### 现有功能
- **多Webview工具**: 通过webview嵌入AI工具（ChatGPT、DeepSeek等）
- **统一输入**: 支持向多个webview同步输入
- **工具切换**: 侧边栏支持多个工具页面切换

### 技术选型（待研究）

#### AI服务集成方案
- **决策**: Electron主进程 + Node.js原生http模块 + 多个AI API支持
- **理由**: 零额外依赖，使用Electron内置能力，通过IPC通信，支持OpenAI、DeepSeek等API
- **体积**: 0KB（零依赖）
- **参考**: research.md 章节 1

#### 状态管理方案
- **决策**: React Context + useState（优先），Zustand（备选，1KB）
- **理由**: 优先零依赖方案，如需要再引入轻量级Zustand
- **体积**: 0-1KB
- **参考**: research.md 章节 2

#### 本地存储方案
- **决策**: Electron文件系统（主进程）
- **理由**: 零依赖，使用Electron内置能力，支持JSON和文本格式
- **体积**: 0KB（零依赖）
- **参考**: research.md 章节 3

#### 文件导出方案
- **决策**: Electron dialog.showSaveDialog
- **理由**: 零依赖，原生系统对话框，用户体验好
- **体积**: 0KB（零依赖）
- **参考**: research.md 章节 4

#### UI组件方案
- **决策**: 复用现有组件 + 新建专用组件
- **理由**: 保持一致性，符合最小依赖原则
- **组件需求**:
  - 文本输入框（多行）
  - 卡片/列表展示（拓展方向）
  - 按钮和交互元素
  - 加载状态指示器
  - 历史记录展示组件
- **参考**: 使用现有UI模式，必要时创建新组件

### 项目结构

```
src/
├── components/
│   ├── PromptExpander/          # Prompt拓展工具主组件（新建）
│   │   ├── PromptExpander.tsx
│   │   ├── PromptExpander.module.css
│   │   ├── InitialInput.tsx     # 初始需求输入组件
│   │   ├── ExpansionOptions.tsx # 拓展方向展示和选择组件
│   │   ├── IterationProgress.tsx # 迭代进度显示组件
│   │   ├── FinalPrompt.tsx       # 最终提示词展示组件
│   │   ├── HistoryView.tsx      # 历史记录查看组件
│   │   └── ...
│   └── ...
├── hooks/
│   ├── usePromptExpander.ts     # Prompt拓展核心逻辑Hook（新建）
│   ├── useAIService.ts          # AI服务调用Hook（新建，待研究）
│   └── ...
├── services/
│   ├── aiService.ts              # AI服务接口封装（新建，待研究）
│   └── storageService.ts        # 本地存储服务（新建，待研究）
├── types/
│   ├── prompt-expander.ts        # Prompt拓展相关类型定义（新建）
│   └── ...
├── utils/
│   ├── promptFormatter.ts       # 提示词格式化工具（新建）
│   └── ...
└── config/
    └── tools.ts                  # 更新：添加新工具配置
```

## Goals

### 主要目标
1. **核心功能**: 实现完整的迭代拓展流程（输入→拓展→选择→...→生成）
2. **AI集成**: 集成AI服务，实现拓展方向生成和最终提示词生成
3. **用户体验**: 提供流畅的交互体验，清晰的进度反馈
4. **数据持久化**: 实现提示词保存和历史记录管理
5. **错误处理**: 完善的错误处理和重试机制

### 成功指标
- 用户能够完成完整的5-10次迭代流程
- AI调用成功率≥95%
- 每次AI生成响应时间<15秒
- 最终提示词生成时间<30秒
- 界面响应时间（非AI操作）<100毫秒
- 提示词保存成功率达到100%

## Approach

### Phase 0: 研究与技术选型
1. **研究AI服务集成方案**
   - 评估webview通信方案可行性
   - 评估独立AI API集成方案
   - 确定最佳实现方式
   
2. **研究状态管理方案**
   - 评估React Context vs 状态管理库
   - 确定状态管理策略
   
3. **研究存储和导出方案**
   - 评估Electron存储API
   - 确定文件导出实现方式
   
4. **生成research.md文档**
   - 记录所有技术决策和理由
   - 解决所有NEEDS CLARIFICATION问题

### Phase 1: 核心功能实现
1. **创建基础组件结构**
   - 初始需求输入组件
   - 拓展方向展示组件
   - 迭代进度组件
   - 最终提示词展示组件
   
2. **实现核心逻辑**
   - 迭代流程状态管理
   - AI服务调用集成
   - 拓展方向生成逻辑
   - 最终提示词生成逻辑
   
3. **实现数据模型和类型定义**
   - 定义迭代状态数据结构
   - 定义拓展方向数据结构
   - 定义提示词数据结构

### Phase 2: 增强功能实现
1. **历史记录功能**
   - 历史记录数据结构
   - 历史记录展示组件
   - 历史记录导航功能
   
2. **保存和导出功能**
   - 本地存储实现
   - 文件导出实现
   - 元数据管理
   
3. **错误处理和用户体验优化**
   - 加载状态优化
   - 错误提示优化
   - 重试机制实现

### Phase 3: 集成和测试
1. **集成到主应用**
   - 添加到工具页面列表
   - 路由和导航集成
   - 样式和主题一致性
   
2. **测试和优化**
   - 功能测试
   - 性能测试
   - 错误场景测试
   - 用户体验测试

## Timeline

### Phase 0: 研究阶段（2-3 天）
- AI服务集成方案研究
- 状态管理和存储方案研究
- 生成research.md
- 技术选型决策

### Phase 1: 核心功能（5-7 天）
- 基础组件开发
- 核心逻辑实现
- AI服务集成
- 数据模型定义

### Phase 2: 增强功能（3-4 天）
- 历史记录功能
- 保存和导出功能
- 错误处理优化

### Phase 3: 集成和测试（2-3 天）
- 主应用集成
- 全面测试
- 问题修复和优化

**总计**: 约 12-17 个工作日

## Risks & Mitigation

### 风险 1: AI服务集成困难
- **风险**: 当前项目没有直接AI API集成，集成方案不明确
- **缓解**: 
  - Phase 0深入研究多种集成方案
  - 评估webview通信和独立API两种方案
  - 准备降级方案（如使用模拟数据先实现UI）
  - 如果必须引入API，选择轻量级方案，符合最小依赖原则

### 风险 2: AI调用性能问题
- **风险**: AI调用响应时间过长，影响用户体验
- **缓解**:
  - 实现合理的超时机制（30秒）
  - 提供清晰的加载状态反馈
  - 实现重试机制（最多3次）
  - 使用异步处理，不阻塞UI
  - 考虑实现请求缓存（如适用）

### 风险 3: 状态管理复杂
- **风险**: 迭代流程状态复杂，难以管理
- **缓解**:
  - 使用清晰的数据结构
  - 将状态逻辑封装到自定义Hook中
  - 如果React Context不够，考虑轻量级状态管理库
  - 充分测试状态转换逻辑

### 风险 4: 数据持久化问题
- **风险**: 本地存储或文件导出功能异常
- **缓解**:
  - 使用Electron标准API
  - 实现完善的错误处理
  - 提供明确的成功/失败反馈
  - 测试不同场景下的存储和导出

### 风险 5: 用户体验不佳
- **风险**: 迭代流程复杂，用户难以理解
- **缓解**:
  - 提供清晰的进度指示
  - 实现直观的交互反馈
  - 提供历史记录查看功能
  - 进行用户测试和反馈收集

## Primary Dependencies

### 必需依赖
- React 18.2.0（已有）
- TypeScript 5.9.3（已有）
- Vite 7.3.1（已有）
- Electron 39.2.7（已有）

### 可选依赖（已确定）
- AI服务集成: Electron主进程 + Node.js原生http模块（零依赖）
- 状态管理: React Context（零依赖），Zustand（可选，1KB）
- 存储: Electron文件系统（零依赖）
- 文件导出: Electron dialog API（零依赖）
- **总体积**: 0-1KB (gzipped)，完全符合最小依赖原则

### 存储
- 本地存储: Electron localStorage 或文件系统
- 数据格式: JSON
- 存储位置: 用户数据目录

## Gates

### Gate 1: 依赖体积检查
- **条件**: 新增依赖总体积 < 50KB (gzipped)
- **验证**: 构建后检查 bundle 大小
- **状态**: ✅ 通过（0-1KB，远低于限制）

### Gate 2: AI服务集成
- **条件**: AI服务集成方案确定，能够成功调用
- **验证**: 实现并测试AI调用功能
- **状态**: ✅ 方案已确定，待实现

### Gate 3: 核心流程完整性
- **条件**: 完整的迭代流程能够正常工作
- **验证**: 端到端测试5-10次迭代流程
- **状态**: ⏳ 待实现

### Gate 4: 性能指标
- **条件**: 
  - AI调用响应时间 < 30秒
  - 界面响应时间 < 100毫秒
  - AI调用成功率 ≥ 95%
- **验证**: 性能测试和监控
- **状态**: ⏳ 待实现后验证

## Next Steps

1. **Phase 0**: 完成技术选型研究，生成research.md，解决所有NEEDS CLARIFICATION
2. **Phase 1**: 开始核心功能实现
3. **Phase 2**: 实现增强功能
4. **Phase 3**: 集成和测试
